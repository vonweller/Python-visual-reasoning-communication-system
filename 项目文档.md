# 基于YOLO的氮磷钾农作物需求识别系统 - 项目文档

## 项目概述

本项目是一个基于YOLO深度学习模型的农作物病害识别系统，专门用于草莓病害的智能检测。系统支持多种视频输入源（本地摄像头、HTTP视频流、MQTT远程摄像头），并通过MQTT协议与外部设备（舵机、水泵等）进行通信，实现智能灌溉控制。

## 技术栈

- **Python**: 主要编程语言
- **PySide6**: Qt GUI框架，用于构建图形界面
- **OpenCV**: 图像处理和视频流处理
- **Ultralytics YOLO**: 目标检测模型（YOLOv8）
- **Paho-MQTT**: MQTT通信协议库
- **NumPy**: 数值计算
- **Pillow**: 图像处理（用于中文标签绘制）

## 项目结构

```
项目根目录/
├── main.py                          # 程序入口
├── requirements.txt                 # 依赖包列表
├── best.pt                         # 训练好的YOLO模型
├── yolov8n.pt                      # YOLOv8n预训练模型
├── config/                         # 配置文件目录
│   ├── config.json                 # 主配置文件
│   └── classes.json                # 类别映射配置
├── core/                           # 核心功能模块
│   ├── config_manager.py          # 配置管理器
│   ├── inference.py               # YOLO推理引擎
│   ├── mqtt_worker.py             # MQTT远程摄像头处理线程
│   └── video_thread.py            # 本地摄像头处理线程
├── ui/                             # 用户界面模块
│   ├── main_window.py             # 主窗口
│   ├── widgets.py                 # 自定义UI组件
│   ├── styles.qss                 # 深色主题样式
│   └── styles_light.qss           # 浅色主题样式
└── 训练的数据data/                 # 训练数据
    └── yolo/
        ├── 63_strawberry_disease_det.yaml  # YOLO数据集配置
        ├── classes.txt             # 类别名称
        ├── train/                  # 训练集
        ├── val/                    # 验证集
        └── test/                   # 测试集
```

## 核心模块详解

### 1. main.py
程序入口文件，初始化PySide6应用并启动主窗口。

### 2. core/config_manager.py
**功能**: 配置文件管理器

**主要方法**:
- `__init__(config_path, classes_path)`: 初始化配置管理器，加载配置文件
- `load_json(path)`: 加载JSON配置文件
- `save_json(path, data)`: 保存JSON配置文件
- `get(key, default=None)`: 获取配置值（支持点号分隔的路径，如"mqtt.broker"）
- `set(key, value)`: 设置配置值并保存

**配置文件结构**:
```json
{
  "mqtt": {
    "broker": "10.1.2.3",
    "port": 1883,
    "username": "siot",
    "password": "dfrobot",
    "publish_topic": "siot/推理结果",
    "topics": [
      {"name": "舵机", "topic": "siot/舵机"},
      {"name": "水泵", "topic": "siot/水泵"},
      {"name": "摄像头", "topic": "siot/摄像头"}
    ]
  },
  "yolo": {
    "model_path": "best.pt",
    "conf_threshold": 0.88,
    "http_stream_url": "http://192.168.10.43:81/stream"
  },
  "ui": {
    "theme": "dark",
    "theme_color": "#007acc"
  }
}
```

### 3. core/inference.py
**功能**: YOLO推理引擎

**类**: `YoloInference`

**初始化参数**:
- `model_path`: 模型文件路径（默认"yolov8n.pt"）
- `conf_threshold`: 置信度阈值（默认0.5）
- `classes_dict`: 类别字典，用于英文到中文的映射

**主要方法**:
- `predict(image)`: 对图像进行推理
  - 输入: OpenCV图像（numpy数组）
  - 输出: (detections, annotated_frame, inference_time)
    - `detections`: 检测结果列表，每个元素包含:
      ```python
      {
        "class_id": int,           # 类别ID
        "class_name_en": str,      # 英文类别名
        "class_name_cn": str,      # 中文类别名
        "confidence": float,       # 置信度
        "bbox": [x1, y1, x2, y2]   # 边界框坐标
      }
      ```
    - `annotated_frame`: 带有标注框和标签的图像
    - `inference_time`: 推理耗时（毫秒）

**特性**:
- 支持中文标签绘制（使用微软雅黑或黑体字体）
- 自动绘制边界框和标签
- 标签格式: "英文类别 (中文类别) 置信度"

### 4. core/video_thread.py
**功能**: 本地摄像头/HTTP视频流处理线程

**类**: `VideoThread` (继承自QThread)

**信号**:
- `frame_processed(object, object)`: 发送处理后的帧和检测结果
- `connection_status(bool, str)`: 发送连接状态

**初始化参数**:
- `camera_id`: 摄像头ID（0表示默认摄像头）或HTTP流URL
- `model_path`: YOLO模型路径
- `conf_threshold`: 置信度阈值
- `classes_dict`: 类别字典

**主要方法**:
- `run()`: 主线程循环，读取视频帧并进行推理
- `stop()`: 停止线程

**特性**:
- 支持本地摄像头（设备ID）
- 支持HTTP视频流（URL）
- 自动优化摄像头分辨率（1280x720）
- 在独立线程中运行推理，避免阻塞UI

### 5. core/mqtt_worker.py
**功能**: MQTT远程摄像头处理线程

**类**: `MqttWorker` (继承自QThread)

**信号**:
- `frame_processed(str, object, object)`: 发送主题、处理后的帧和检测结果
- `connection_status(bool, str)`: 发送连接状态

**初始化参数**:
- `broker`: MQTT服务器地址
- `port`: MQTT端口
- `topics`: 订阅的主题列表（字典列表，格式: [{"name": "...", "topic": "..."}]）
- `username`: MQTT用户名
- `password`: MQTT密码
- `model_path`: YOLO模型路径
- `conf_threshold`: 置信度阈值
- `classes_dict`: 类别字典

**主要方法**:
- `run()`: 连接MQTT服务器并订阅主题
- `stop()`: 停止线程并断开连接
- `on_connect()`: 连接成功回调
- `on_disconnect()`: 断开连接回调
- `on_message()`: 接收消息回调（处理base64编码的图像）
- `publish_message(topic, payload)`: 发布消息到指定主题

**特性**:
- 支持base64编码的图像数据
- 自动处理图像解码
- 在独立线程中运行推理
- 支持多主题订阅

### 6. ui/main_window.py
**功能**: 主窗口界面

**类**: `MainWindow` (继承自QMainWindow)

**界面标签页**:
1. **本地图片**: 加载本地图片进行推理
2. **摄像头**: 实时本地摄像头检测
3. **HTTP监控**: HTTP视频流实时检测
4. **MQTT远程**: 接收MQTT远程摄像头图像进行检测
5. **设置**: 配置MQTT、推理参数、界面主题等

**主要方法**:
- `setup_ui()`: 初始化界面布局
- `setup_local_tab()`: 设置本地图片标签页
- `setup_camera_tab()`: 设置摄像头标签页
- `setup_http_tab()`: 设置HTTP监控标签页
- `setup_mqtt_tab()`: 设置MQTT远程标签页
- `setup_settings_tab()`: 设置配置标签页
- `load_image()`: 加载单张图片
- `load_folder()`: 批量导入文件夹中的图片
- `process_local_image(path)`: 处理本地图片
- `toggle_camera()`: 开启/关闭本地摄像头
- `toggle_http_camera()`: 开启/关闭HTTP视频流
- `toggle_mqtt()`: 连接/断开MQTT
- `save_settings()`: 保存配置
- `log_result(source, detections)`: 记录推理结果到日志表格并发布到MQTT
- `apply_styles()`: 应用主题样式

**主题颜色选项**:
- 科技蓝 (#007acc)
- 翡翠绿 (#28a745)
- 活力橙 (#fd7e14)
- 玫瑰红 (#dc3545)
- 深邃紫 (#6f42c1)
- 天空蓝 (#17a2b8)
- 柠檬黄 (#ffc107)
- 极简灰 (#6c757d)
- 暗夜黑 (#000000)
- 樱花粉 (#e83e8c)

### 7. ui/widgets.py
**功能**: 自定义UI组件

**类**:

1. **ImageDisplayWidget**: 图像显示组件
   - 显示标题和图像
   - 自动缩放图像以适应组件大小
   - 保持宽高比

2. **LogTableWidget**: 日志表格组件
   - 5列: 时间、来源、英文类别、中文类别、置信度
   - 自动滚动到底部
   - 记录计数器

## 检测类别

系统可以检测以下7种草莓病害:

| 类别ID | 英文名称 | 中文名称 |
|--------|----------|----------|
| 0 | Angular Leafspot | 角斑病 |
| 1 | Leaf Spot | 叶斑病 |
| 2 | Powdery Mildew Leaf | 白粉病叶 |
| 3 | Blossom Blight | 花枯病 |
| 4 | Anthracnose Fruit Rot | 炭疽果腐病 |
| 5 | Gray Mold | 灰霉病 |
| 6 | Powdery Mildew Fruit | 白粉病果 |
| 7 | 无目标 | 无目标 |

## MQTT通信协议

### 订阅主题
- `siot/舵机`: 舵机控制
- `siot/水泵`: 水泵控制
- `siot/摄像头`: 摄像头图像（base64编码）

### 发布主题
- `siot/推理结果`: 推测结果（中文类别名称，多个结果用逗号分隔）

### 图像格式
MQTT接收的图像数据格式:
```
data:image/png;base64,<base64编码的图像数据>
```

## 使用流程

### 1. 本地图片检测
1. 点击"本地图片"标签页
2. 点击"加载图片"选择单张图片，或点击"批量导入"选择文件夹
3. 系统自动进行推理并显示结果
4. 结果记录在底部日志表格中

### 2. 本地摄像头检测
1. 点击"摄像头"标签页
2. 点击"开启摄像头"
3. 系统实时显示摄像头画面并进行推理
4. 点击"关闭摄像头"停止检测

### 3. HTTP视频流检测
1. 点击"HTTP监控"标签页
2. 输入HTTP视频流地址（如: http://192.168.1.32:81/stream）
3. 点击"开启HTTP监控"
4. 系统实时显示视频流并进行推理
5. 点击"关闭HTTP监控"停止检测

### 4. MQTT远程摄像头检测
1. 在"设置"标签页配置MQTT服务器信息
2. 点击"MQTT远程"标签页
3. 点击"连接MQTT"
4. 系统订阅配置的主题并接收远程摄像头图像
5. 实时显示图像并进行推理
6. 推理结果自动发布到`siot/推理结果`主题
7. 点击"断开MQTT"停止连接

### 5. 配置设置
1. 点击"设置"标签页
2. 修改MQTT连接信息（服务器、端口、用户名、密码）
3. 调整推理置信度阈值
4. 选择界面模式（深色/浅色）和主题颜色
5. 管理MQTT订阅主题（添加/删除）
6. 点击"保存配置"保存所有设置

## 依赖安装

```bash
pip install -r requirements.txt
```

依赖包列表:
- ultralytics
- pyside6
- opencv-python
- paho-mqtt
- Pillow
- numpy

## 运行程序

```bash
python main.py
```

## 关键特性

1. **多输入源支持**: 本地图片、本地摄像头、HTTP视频流、MQTT远程摄像头
2. **实时推理**: 使用多线程技术，确保UI流畅
3. **中文标签**: 自动绘制中文类别标签
4. **MQTT集成**: 支持与外部设备通信，实现智能控制
5. **可配置界面**: 支持深色/浅色主题和多种主题颜色
6. **日志记录**: 自动记录所有推理结果
7. **批量处理**: 支持批量导入图片进行推理

## 应用场景

本系统可应用于:
- 智能农业：自动检测农作物病害
- 精准灌溉：根据检测结果控制水泵和舵机
- 远程监控：通过MQTT远程监控农田状态
- 科研教学：用于植物病害识别研究

## 注意事项

1. 确保摄像头设备正常连接
2. MQTT服务器需要正确配置并运行
3. HTTP视频流地址需要可访问
4. 模型文件（best.pt）需要存在于项目根目录
5. 中文标签需要系统支持中文字体（微软雅黑或黑体）
